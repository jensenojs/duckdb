
# 引言

随着数据库系统规模和复杂性的不断增长，查询调度与协调机制在现代数据库系统中扮演着越来越重要的角色。它们不仅影响着系统的性能和可扩展性，还直接关系到用户体验和系统稳定性。有效的查询调度能够优化资源利用率，减少查询响应时间，提升系统的并发处理能力。

## 调度与协调

查询调度与查询协调是两个密切相关但又有所区别的概念:

- 调度：发生在查询执行前和执行过程中，属于"决策层面"
	- 解决"何时执行"和"用什么资源执行"的问题
	- 确保系统整体资源利用率最优
	- 平衡多查询间的资源竞争
- 协调：贯穿查询执行全过程，属于"执行层面"
	- 调度决策的具体落地
	- 执行器的资源约束实施
	- 反馈资源使用状况, 以便后续的调度
		- 执行状态的跟踪
		- 资源使用状况的监控
		- 异常情况的发现与报告

## 演进


随着技术的发展，调度和协调机制经历了显著的演进。从早期的简单调度算法到如今的复杂并行和分布式调度策略，研究者们不断探索如何更好地利用现代硬件架构和软件技术。

近年来，弹性调度、智能调度和 NUMA 感知优化等新技术的引入，使得数据库的能力越来越强大, 但是数据规模的爆炸, 数据分布及数据类型的复杂化, 以及负载的变化, 依然在这个模块提出新的挑战.

- **资源管理复杂性**
  - 多维度资源协调
  - 动态负载平衡
  - 资源竞争处理

- **性能优化难度**
  - 查询代价估算困难
  - 并行度选择复杂
  - 负载预测不准确

- **系统可扩展性**
  - 分布式环境协调
  - 弹性伸缩支持
  - 一致性保证

## 设计目标

查询调度与协调系统的设计需要平衡多个目标, 在传统的最大化资源利用率最优性能之余, 还有两个值得特别一提的目标

### 水平扩展

- **可扩展性挑战**
  如《Morsel-Driven Parallelism》中指出：
  - 传统的计划驱动并行化方法难以扩展到数百个核心
  - 即使有准确的数据统计信息，工作负载的均匀分配仍然困难
  - 现代处理器的乱序执行增加了工作负载预测的复杂性

### 负载均衡

负载均衡的目标是将查询请求均匀地分配到不同的节点或资源，以避免系统过载或资源利用不均衡，是查询调度中的一个重要目标。

常用的负载均衡策略包括
- **静态负载均衡**：在系统初始化时分配资源，适用于负载相对稳定的应用[^Ailamaki2014^]。
- **动态负载均衡**：根据实时负载动态调整资源分配，适应负载波动[^Psaroudakis2013^]。 
- **自适应负载均衡**：基于负载预测和反馈机制，自动调整负载分配策略。例如，Froid 框架通过动态编译 PL/SQL 函数为 SQL 子查询，优化了查询执行计划，减少了上下文切换开销[^Willhalm2009^]。



- **Morsel-Driven 并行框架**
  《Morsel-driven parallelism》提出的框架针对分析查询性能的主要瓶颈进行优化：
  - 改善负载平衡
  - 优化线程同步
  - 提供极高的性能提升

# 系统架构

现代数据库系统的查询调度与协调架构通常采用分层设计，每一层都有其特定的职责和功能。这种分层设计不仅提高了系统的可维护性，也使得各个组件能够相对独立地演化, 其实这里是我瞎掰的



## 策略层

- **查询调度策略**
	- 查询优先级管理, 执行时序安排, 负载均衡决策
- 资源规划策略
	- 资源配额制定, 多租户资源策略, 容量规划决策
- **策略优化**：通过分析历史数据和实时反馈，不断优化调度策略以提高系统性能。
   - **策略适应性**：能够根据系统负载和外部环境的变化动态调整策略。
	   - 决策依据
		   - 系统状态信息
		   - 历史执行数据
		   - 性能监控指标
		   - 用户服务级别协议 (SLA)

## 协调层

作为策略到执行的桥接层：
- 策略实施协调
	- 调度决策转换为具体执行方案
	- 资源限制的具体分配方案
	- 性能目标的分解与追踪
- 状态管理与反馈
	- 执行状态跟踪
	- 资源使用监控
	- 性能指标收集
- 异常处理协调
	- 资源竞争协调
	- 执行异常处理
	- 性能问题报告

### 性能监控与评估

全面的性能监控和诊断系统是优化的基础设施

- **监控维度**
  - 系统级指标
    - CPU 使用率
    - 内存占用
    - I/O 吞吐量
    - 网络带宽
  - 查询级指标
    - 响应时间
    - 等待事件
    - 资源消耗
    - 执行计划
- **诊断方法**
  - 性能瓶颈识别
  - 异常模式检测
  - 根因分析
  - 优化建议生成
- **反馈调整机制**
	- **性能反馈**
	   - 收集查询执行统计
	   - 识别性能瓶颈
	   - 调整调度参数
   - **负载反馈**
	   - 监控系统负载
	   - 检测资源竞争
	   - 动态调整并行度



## 基础设施层:资源管理

  资源管理是查询调度的重要组成部分，涉及 CPU、内存、I/O 和网络资源的管理和优化, 也是调度的基础设施
  
### CPU

**CPU 调度**：涉及线程池管理、任务分配和 CPU 核心的动态调整。例如，Iraklis Psaroudakis 等人在《Task Scheduling for Highly Concurrent Analytical and Transactional Main-Memory Workloads》中提出了一种动态任务调度器，能够根据任务的阻塞情况动态调整并发级别，有效利用 CPU 资源[^Psaroudakis2013^]。


### 内存


- **内存管理**：包括内存分配、数据缓存和 NUMA 感知优化。Viktor Leis 等人在《Morsel-Driven Parallelism: A NUMA-Aware Query Evaluation Framework for the Many-Core Age》中提出了 Morsel-Driven 框架，通过细粒度的运行时调度，动态分配小块数据（morsels）到工作线程，优化了 NUMA 架构下的内存访问[^Leis2014^]。


- **NUMA 架构优化**
  Viktor Leis 等人在《Morsel-Driven Parallelism: A NUMA-Aware Query Evaluation Framework for the Many-Core Age》中提出的 Morsel-Driven 框架：
  - 通过细粒度的运行时调度
  - 动态分配小块数据（morsels）到工作线程
  - 优化 NUMA 架构下的内存访问


### 持久化设备

对于多核多插槽服务器环境，《OLTP on hardware islands. pdf》提出硬件拓扑和工作负载感知的共享无配置（OLTP Islands）策略，以适应硬件异质性并提高 OLTP 系统的性能。


### 网络

在分布式环境中，网络资源管理直接影响查询性能：

- **带宽分配**
  - QoS 保证
  - 带宽限制
  - 优先级管理
  - 流量整形

- **通信开销优化**
  - 数据压缩
  - 批量传输
  - 协议优化
  - 本地性优化

- **网络资源管理**：在分布式数据库中，优化节点间的数据传输和通信开销。例如，通过数据压缩和高效的数据传输协议减少网络延迟[^Stonebraker2007^]。

### 资源隔离

有效的资源隔离确保系统稳定性和性能可预测性：

- **隔离机制**
  - CPU 资源隔离
    - 线程池隔离
    - CPU 配额限制
    - 优先级管理
  - 内存资源隔离
    - 内存池划分
    - 缓存隔离
    - 溢出控制
  - I/O 资源隔离
    - I/O 带宽限制
    - 存储配额管理
    - 优先级调度

- **服务质量保证**
  - SLA 监控
  - 性能基线维护
  - 资源调整策略
  - 违约处理机制

## 层间交互小结

1. 策略层 → 协调层
	- 下发调度决策
	- 传递资源策略
	- 设定性能目标
2. 协调层 → 资源管理层
	- 资源分配请求
	- 执行控制指令
	- 监控需求
3. 资源管理层 → 协调层 → 策略层
	- 资源使用状况
	- 执行效果反馈
	- 性能指标报告

# 查询调度


1. **简单性**：避免过度复杂的调度策略
2. **可预测性**：调度行为应该是可理解和可预测的
3. **可观测性**：提供充分的监控和诊断能力
4. **可扩展性**：支持系统规模的横向和纵向扩展

查询调度模型主要分为集中式调度、分布式调度和混合调度。
- **集中式调度**：所有调度决策由一个中心调度器完成，易于实现和管理，但可能成为性能瓶颈。例如，传统的数据库系统通常采用集中式调度器来管理查询的执行顺序和资源分配。
- **分布式调度**：调度决策分散到多个节点，提高了系统的可扩展性，但增加了协调开销。在分布式数据库系统中，每个节点可以独立地调度本地查询，但需要协调全局资源。
- **混合调度**：结合集中式和分布式调度的优点，根据应用场景动态选择调度模式。例如，某些系统在初始化时采用集中式调度，而在运行时根据负载动态切换到分布式调度。

### 调度策略

#### 自顶向下的调度方法

自顶向下的调度方法强调从全局视角出发，制定整体调度策略。在《Scaling Up Concurrent Main-Memory Column-Store Scans. pdf》中，研究者提出了一种自适应的 NUMA 感知调度策略，通过全局优化内存访问模式来提升系统性能。这种方法适用于需要高效资源利用和全局负载均衡的场景。

此外，SQL Server 的并行查询处理技术也展示了通过交换操作符来优化查询执行计划的能力。这种全局视角的调度方法在处理复杂查询时具有显著优势。

- **核心特征**
  - 全局资源视图
  - 整体性能优化
  - 集中式决策

- **实现案例**
  在《Scaling Up Concurrent Main-Memory Column-Store Scans》中，研究者提出了一种自适应的 NUMA 感知调度策略，通过全局优化内存访问模式来提升系统性能。这种方法适用于需要高效资源利用和全局负载均衡的场景。

- **应用场景**
  - 资源密集型查询
  - 复杂的并行处理
  - 需要全局优化的场景

#### 自底向上的调度方法

自底向上的调度方法则注重从具体资源使用情况出发，逐步优化调度策略。在《Task Scheduling for Highly Concurrent Analytical and Transactional Main-Memory. pdf》中，研究者通过动态调整任务调度器的并发级别，优化了内存数据库的任务调度。这种方法在处理高并发负载时表现出色，尤其适合动态变化的工作负载环境。

PostgreSQL 的调度机制通过监控系统资源和查询特征，动态调整调度策略，以适应不同的负载需求。

- **核心特征**
  - 局部资源感知
  - 渐进式优化
  - 分散式决策

- **实现案例**
  在《Task Scheduling for Highly Concurrent Analytical and Transactional Main-Memory》中，研究者通过动态调整任务调度器的并发级别，优化了内存数据库的任务调度。这种方法在处理高并发负载时表现出色，尤其适合动态变化的工作负载环境。

- **应用场景**
  - 高并发场景
  - 资源动态变化
  - 需要快速响应的场景

#### 自适应调度

自适应调度策略能够根据系统状态和负载特征动态调整调度行为：

- **核心机制**
  - 负载感知：实时监控系统负载
  - 动态调整：自动适应负载变化
  - 反馈优化：基于执行反馈调整策略

在《Wagner 等 - 2021 - Self-Tuning Query Scheduling for Analytical Workloads. pdf》中，研究者提出了一种自调节查询调度器，通过任务并行化和自适应调整任务优先级与粒度，优化了查询延迟。这种协调机制在高负载情况下能够显著提升短查询的响应速度。

部分调度器能够动态调整并发级别，像《Task Scheduling for Highly Concurrent Analytical and Transactional Main - Memory. pdf》中的调度器，通过动态调整任务调度器的并发级别和使用并发提示，在内存 DBMS 中对高度并发的分析和事务工作负载性能提升效果显著，分析查询性能提升可达 16%，混合工作负载中的事务查询性能提升可达 370%。还有的调度器可以根据工作负载的变化自适应地改变任务的优先级和粒度。《Wagner 等 - 2021 - Self - Tuning Query Scheduling for Analytical Workloads. pdf》中的调度器通过模拟自身执行基于跟踪的工作负载来透明地优化查询延迟，在高负载下仍能保持短查询的近最优延迟。


在《Scaling Up Concurrent Main-Memory Column-Store Scans. pdf》这篇论文中，强调了自适应的 NUMA（非一致性内存访问）感知数据和任务调度策略的重要性。研究指出，不必要的分区和内存密集型任务的窃取会导致显著的吞吐量下降，分别高达 70%和 58%。这意味着在设计查询调度器时，需要充分考虑内存的分布和访问特性，以避免性能损失。

## 多租户调度

多租户环境下，调度策略需要考虑不同租户的资源隔离和公平性。通过动态资源分配和优先级调整，确保各租户的服务质量。近年来，研究者们提出了多种多租户调度算法，以优化资源利用率和租户满意度。

- **核心需求**
  - 资源隔离：为不同租户分配独立资源
  - 公平调度：保证资源分配的公平性
  - QoS 保证：满足不同租户的服务质量要求

- **实现机制**
  - 资源配额：为租户分配资源配额
  - 优先级管理：动态调整查询优先级
  - 负载控制：防止单个租户过度消耗资源

## 混合负载调度

在混合负载环境下，需要平衡不同类型查询的需求：

- **OLTP/OLAP 混合**
  - 特点：同时处理交易和分析查询
  - 挑战：资源竞争和性能隔离
  - 策略：动态资源分区和优先级调整

- **批处理/流处理混合**
  - 特点：同时处理批量和实时查询
  - 需求：保证不同类型任务的延迟要求
  - 优化：资源预留和动态调整

关键挑战在于资源竞争和性能隔离。通过动态资源分区和优先级调整，可以有效避免长查询饿死短查询的问题。

***

在实际应用中，数据库系统通常需要同时处理多种类型的查询，例如 OLTP 查询、OLAP 查询、批处理任务等。混合负载调度需要
- OLTP/OLAP 混合: 同时处理 OLTP 和 OLAP 类型的查询，保证两种类型查询的性能需求，避免资源竞争。
- 批处理/流处理混合: 同时处理批处理和流处理任务，保证不同类型任务的延迟需求，提高系统整体效率。
- 优先级调度: 根据查询的优先级进行调度，保证高优先级查询的快速响应，同时兼顾低优先级查询的完成时间

***

不同类型的工作负载（分析型和事务型）对调度有不同的要求。例如分析工作负载可能更关注查询的整体处理速度，而事务工作负载往往需要较低的响应延迟。《Wagner等 - 2021 - Self - Tuning Query Scheduling for Analytical Workloads. pdf》中的自调节查询调度器就是针对分析工作负载设计的，通过自适应调整任务优先级和粒度来优化查询延迟。工作负载的动态性也给调度带来挑战。如在《OLTP on hardware islands. pdf》提到的现代多核多插槽服务器环境下，OLTP系统面临着硬件异质性，传统的调度策略难以适应这种复杂的工作负载环境，导致性能不稳定。

## 弹性调度

弹性调度是指根据负载变化动态调整资源分配，以提高资源利用率和系统灵活性。弹性调度主要依赖于
- 动态资源分配: 根据系统负载和查询需求动态调整资源分配，提高资源利用率，降低查询延迟。
- 负载预测: 预测未来系统负载变化趋势，提前进行资源预留和调度优化，避免资源瓶颈。
- 自动扩缩容: 根据系统负载情况自动调整系统规模，保证系统始终能够满足用户需求，同时避免资源浪费。

- **实现策略**
  - 资源池管理
  - 负载均衡
  - 容量规划

# 查询协调

TODO



# 新兴技术应用

- **机器学习**：利用机器学习算法，预测查询负载变化趋势，优化调度策略，提高系统资源利用率。
- **强化学习**：利用强化学习算法，根据系统运行状态动态调整调度策略，实现自适应的资源管理和调度。
- **深度学习**：利用深度学习算法，分析查询特征和系统运行数据，挖掘潜在的优化机会，提高调度效率和查询性能。


## 参考文献

[1] Leis V, Boncz P, Kemper A, et al. Morsel-driven parallelism: a NUMA-aware query evaluation framework for the many-core age[C]//Proceedings of the 2014 ACM SIGMOD international conference on Management of data. 2014: 743-754.

[2] Psaroudakis I, Scheuer T, May N, et al. Task scheduling for highly concurrent analytical and transactional main-memory workloads[J]. Proceedings of the VLDB Endowment, 2015, 8 (12): 1802-1813.

[3] Lang H, Mühlbauer T, Funke F, et al. Data blocks: hybrid OLTP and OLAP on compressed storage using both vectorization and compilation[C]//Proceedings of the 2016 International Conference on Management of Data. 2016: 311-326.

[4] Pandis I, Johnson R, Hardavellas N, et al. Data-oriented transaction execution[J]. Proceedings of the VLDB Endowment, 2010, 3 (1-2): 928-939.

[5] Schuh S, Chen X, Dittrich J. An experimental comparison of thirteen relational equi-joins in main memory[C]//Proceedings of the 2016 International Conference on Management of Data. 2016: 1961-1976.

[6] Mönkeberg A, Weikum G. Performance evaluation of an adaptive and robust load control method for the avoidance of data-contention thrashing[C]//VLDB. 1992, 92: 432-443.

[7] O'Gorman K, El Abbadi A, Agrawal D. Multiple query optimization in middleware using query teamwork[J]. Software: Practice and Experience, 2005, 35 (4): 361-391.

[8] Pang H, Carey M J, Livny M. Multiclass query scheduling in real-time database systems[J]. IEEE Transactions on Knowledge and Data Engineering, 1995, 7 (4): 533-551.

[9] Roy P, Seshadri S, Sudarshan S, et al. Efficient and extensible algorithms for multi query optimization[C]//Proceedings of the 2000 ACM SIGMOD International Conference on Management of data. 2000: 249-260.

[10] Schroeder B, Harchol-Balter M. Web servers under overload: How scheduling can help[J]. ACM Transactions on Internet Technology (TOIT), 2006, 6 (1): 20-52.

[11] Zhang Q, Cherkasova L, Mathews G, et al. R-capriccio: A capacity planning and anomaly detection tool for enterprise services with live workloads[C]//ACM/IFIP/USENIX International Conference on Distributed Systems Platforms and Open Distributed Processing. Springer, Berlin, Heidelberg, 2007: 244-265.

[12] Narasayya V, Chaudhuri S, Ives Z, et al. Multi-Tenant Cloud Data Services: State-of-the-Art, Challenges and Opportunities[C]//Proceedings of the 2022 International Conference on Management of Data. 2022: 2465-2473.

[13] Das J, Ghosh S, Ghosh S, et al. LYRIC: Deadline and Budget Aware Spatio-Temporal Query Processing in Cloud[J]. IEEE Transactions on Services Computing, 2022, 15 (5): 2869-2882.

[14] Chauque E, Arai I, Fujikawa K. Reducing Tail Latency In Cassandra Cluster Using Regression Based Replica Selection Algorithm[C]//2020 IEEE Global Conference on Artificial Intelligence and Internet of Things (GCAIoT). IEEE, 2020: 1-7.

[15] Kelley J, Stewart C, Morris N, et al. Obtaining and Managing Answer Quality for Online Data-Intensive Services[J]. ACM Transactions on Modeling and Performance Evaluation of Computing Systems, 2017, 2 (2): 1-31.

[16] Li J, Naughton J, Nehme R V. Resource bricolage and resource selection for parallel database systems[J]. The VLDB Journal, 2017, 26 (1): 31-54.

[17] Kuschewski M, Giceva J, Neumann T, et al. High-Performance Query Processing with NVMe Arrays: Spilling without Killing Performance[J]. Proceedings of the ACM on Management of Data, 2024, 2 (6): 1-27.

[18] Schulze R, Schreiber T, Yatsishin I, et al. ClickHouse - Lightning Fast Analytics for Everyone[J]. Proceedings of the VLDB Endowment, 2024, 17 (12): 3731-3744.

[19] Leis V, Dietrich C. Cloud-Native Database Systems and Unikernels: Reimagining OS Abstractions for Modern Hardware[J]. Proceedings of the VLDB Endowment, 2024, 17 (8): 2115-2122


- 核心理论论文：

- Morsel-driven并行框架 [1]

- 高并发分析和事务性工作负载的任务调度 [2]

- 混合OLTP和OLAP的数据块处理 [3]

- 调度与优化相关：

- 数据导向的事务执行 [4]

- 内存中关系连接的实验比较 [5]

- 自适应负载控制 [6]

- 查询优化与协调：

- 多查询优化 [7,9]

- 实时数据库系统中的多类查询调度 [8]

- 过载条件下的调度优化 [10]

- 云计算与新技术：

- 多租户云数据服务 [12]

- 云环境中的查询处理 [13]

- 基于AI的延迟优化 [14]

- 最新研究进展：

- NVMe阵列的高性能查询处理 [17]

- ClickHouse的快速分析 [18]

- 云原生数据库系统 [19]